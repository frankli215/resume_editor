<script setup>
import { ref, computed, reactive } from 'vue'
import { useResumeStore } from '../stores/resume'
import BasicInfoEditor from './modules/BasicInfoEditor.vue'
import JobIntentionEditor from './modules/JobIntentionEditor.vue'
import WorkExperienceEditor from './modules/WorkExperienceEditor.vue'
import EducationEditor from './modules/EducationEditor.vue'
import ProjectEditor from './modules/ProjectEditor.vue'
import SkillsEditor from './modules/SkillsEditor.vue'
import SelfEvaluationEditor from './modules/SelfEvaluationEditor.vue'

// ä½¿ç”¨ç®€åŽ†å­˜å‚¨
const resumeStore = useResumeStore()

// å¯ç”¨çš„æ¨¡å—
const enabledModules = computed(() => {
  return resumeStore.orderedEnabledModules.map(module => ({ id: module.id }))
})

const selectedEntry = ref(null)
const dragOverIndex = ref(null)
const draggedIndex = ref(null)

// æ–°æ¡ç›®è¡¨å•æ•°ç»„ï¼Œä¸ºæ¯ä¸ªæ¨¡å—ç±»åž‹ç»´æŠ¤ä¸€ä¸ªæ•°ç»„
const newEntries = reactive({
  'work-experience': [{
    company: '',
    position: '',
    startDate: '',
    endDate: '',
    description: ''
  }],
  'education': [{
    school: '',
    major: '',
    degree: '',
    startDate: '',
    endDate: ''
  }],
  'project': [{
    name: '',
    role: '',
    startDate: '',
    endDate: '',
    description: ''
  }]
})

// å•æ¡ç›®æ¨¡å—åˆ—è¡¨ï¼ˆä¸åŒ…æ‹¬å·¥ä½œç»åŽ†ï¼‰
const singleEntryModules = ['basic-info', 'job-intention', 'skills', 'self-evaluation']

// å¤šæ¡ç›®æ¨¡å—åˆ—è¡¨ï¼ˆåŒ…æ‹¬å·¥ä½œç»åŽ†ï¼‰
const multiEntryModules = ['work-experience', 'education', 'project']

// åˆ¤æ–­æ˜¯å¦ä¸ºå•æ¡ç›®æ¨¡å—
const isSingleEntryModule = (moduleId) => {
  return singleEntryModules.includes(moduleId)
}

// åˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ¡ç›®æ¨¡å—
const isMultiEntryModule = (moduleId) => {
  return multiEntryModules.includes(moduleId)
}

// èŽ·å–æ¨¡å—åç§°
const getModuleName = (moduleId) => {
  const names = {
    'basic-info': 'åŸºç¡€ä¿¡æ¯',
    'job-intention': 'æ±‚èŒæ„å‘',
    'work-experience': 'å·¥ä½œç»åŽ†',
    'education': 'æ•™è‚²ç»åŽ†',
    'project': 'é¡¹ç›®ç»åŽ†',
    'skills': 'æŠ€èƒ½è¯ä¹¦',
    'self-evaluation': 'è‡ªæˆ‘è¯„ä»·'
  }
  return names[moduleId] || moduleId
}

// èŽ·å–æ¨¡å—å›¾æ ‡
const getModuleIcon = (moduleId) => {
  const icons = {
    'basic-info': 'ðŸ‘¤',
    'job-intention': 'ðŸŽ¯',
    'work-experience': 'ðŸ’¼',
    'education': 'ðŸŽ“',
    'project': 'ðŸ“',
    'skills': 'ðŸ”§',
    'self-evaluation': 'ðŸ’¬'
  }
  return icons[moduleId] || 'ðŸ“„'
}

// èŽ·å–æ¨¡å—ç»„ä»¶
const getModuleComponent = (moduleId) => {
  const components = {
    'basic-info': BasicInfoEditor,
    'job-intention': JobIntentionEditor,
    'work-experience': WorkExperienceEditor,
    'education': EducationEditor,
    'project': ProjectEditor,
    'skills': SkillsEditor,
    'self-evaluation': SelfEvaluationEditor
  }
  return components[moduleId] || 'div'
}

// æ£€æŸ¥æ¨¡å—æ˜¯å¦æœ‰æ¡ç›®
const hasEntries = (moduleId) => {
  const data = resumeStore[moduleId]
  if (Array.isArray(data)) {
    return data.length > 0
  }
  // å¯¹äºŽå•æ¡ç›®æ¨¡å—ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®žé™…æ•°æ®
  if (isSingleEntryModule(moduleId)) {
    if (!data) return false
    // æ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰éžç©ºå±žæ€§ï¼ˆæŽ’é™¤ç©ºå­—ç¬¦ä¸²ï¼‰
    return Object.values(data).some(value => {
      // å¦‚æžœå€¼å­˜åœ¨ä¸”ä¸ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è®¤ä¸ºæœ‰æ•°æ®
      return value !== undefined && value !== null && value !== ''
    })
  }
  return !!data
}

// èŽ·å–æ¨¡å—æ¡ç›®
const getModuleEntries = (moduleId) => {
  return resumeStore[moduleId] || []
}

// èŽ·å–å•æ¡ç›®æ¨¡å—çš„æ•°æ®ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
const getModuleData = (moduleId) => {
  const storeData = resumeStore[moduleId] || {}
  
  // æ ¹æ®æ¨¡å—ç±»åž‹è¿”å›žå¸¦é»˜è®¤å€¼çš„æ•°æ®
  switch (moduleId) {
    case 'basic-info':
      return {
        name: storeData.name || 'å¼ ä¸‰',
        phone: storeData.phone || '138-0000-0000',
        email: storeData.email || 'zhangsan@example.com',
        address: storeData.address || 'åŒ—äº¬å¸‚æœé˜³åŒºæŸæŸè¡—é“'
      }
    case 'job-intention':
      return {
        position: storeData.position || 'å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ',
        industry: storeData.industry || 'äº’è”ç½‘/IT',
        salary: storeData.salary || '15K-20K',
        city: storeData.city || 'åŒ—äº¬'
      }
    case 'skills':
      return {
        skills: storeData.skills && storeData.skills.length > 0 ? storeData.skills : ['HTML/CSS', 'JavaScript', 'Vue.js', 'React', 'Node.js']
      }
    case 'self-evaluation':
      return {
        content: storeData.content || 'å…·å¤‡3å¹´å‰ç«¯å¼€å‘ç»éªŒï¼Œç†Ÿç»ƒæŽŒæ¡Vue.jså’ŒReactæ¡†æž¶ï¼Œæœ‰ä¸°å¯Œçš„Webåº”ç”¨å¼€å‘ç»éªŒã€‚å…·å¤‡è‰¯å¥½çš„æ²Ÿé€šèƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥žï¼Œèƒ½å¤Ÿå¿«é€Ÿé€‚åº”æ–°çŽ¯å¢ƒå¹¶æ‰¿æ‹…å·¥ä½œåŽ‹åŠ›ã€‚'
      }
    default:
      return storeData
  }
}

// æ›´æ–°æ–°æ¡ç›®æ•°æ®
const updateNewEntry = (moduleId, entryIndex, data) => {
  if (newEntries[moduleId] && newEntries[moduleId][entryIndex]) {
    newEntries[moduleId][entryIndex] = { ...newEntries[moduleId][entryIndex], ...data }
  }
}

// æ·»åŠ æ–°æ¡ç›®è¡¨å•
const addEntry = (moduleId) => {
  if (newEntries[moduleId]) {
    // æ ¹æ®æ¨¡å—ç±»åž‹æ·»åŠ ç©ºçš„æ–°æ¡ç›®è¡¨å•
    switch (moduleId) {
      case 'work-experience':
        newEntries[moduleId].push({
          company: '',
          position: '',
          startDate: '',
          endDate: '',
          description: ''
        })
        break
      case 'education':
        newEntries[moduleId].push({
          school: '',
          major: '',
          degree: '',
          startDate: '',
          endDate: ''
        })
        break
      case 'project':
        newEntries[moduleId].push({
          name: '',
          role: '',
          startDate: '',
          endDate: '',
          description: ''
        })
        break
    }
  }
}

// ä»Žè¡¨å•æ·»åŠ æ–°æ¡ç›®
const addEntryFromForm = (moduleId, entryIndex) => {
  // æ·»åŠ æ–°æ¡ç›®
  if (newEntries[moduleId] && newEntries[moduleId][entryIndex]) {
    const entryData = newEntries[moduleId][entryIndex]
    
    switch (moduleId) {
      case 'work-experience':
        resumeStore.addWorkExperience(entryData)
        break
      case 'education':
        resumeStore.addEducation(entryData)
        break
      case 'project':
        resumeStore.addProject(entryData)
        break
    }
    
    // ç§»é™¤å·²æ·»åŠ çš„è¡¨å•
    removeNewEntryForm(moduleId, entryIndex)
    
    // æ·»åŠ ä¸€ä¸ªæ–°çš„ç©ºè¡¨å•
    addEntry(moduleId)
  }
}

// ç§»é™¤æ–°æ¡ç›®è¡¨å•
const removeNewEntryForm = (moduleId, entryIndex) => {
  if (newEntries[moduleId] && newEntries[moduleId][entryIndex]) {
    newEntries[moduleId].splice(entryIndex, 1)
    // ç¡®ä¿å§‹ç»ˆè‡³å°‘æœ‰ä¸€ä¸ªç©ºè¡¨å•
    if (newEntries[moduleId].length === 0) {
      addEntry(moduleId)
    }
  }
}

// æ›´æ–°æ¡ç›®
const updateEntry = (moduleId, entryIndex, data) => {
  switch (moduleId) {
    case 'basic-info':
      resumeStore.updateBasicInfo(data)
      break
    case 'job-intention':
      resumeStore.updateJobIntention(data)
      break
    case 'work-experience':
      resumeStore.updateWorkExperience(entryIndex, data)
      break
    case 'education':
      resumeStore.updateEducation(entryIndex, data)
      break
    case 'project':
      resumeStore.updateProject(entryIndex, data)
      break
    case 'skills':
      resumeStore.updateSkills(data)
      break
    case 'self-evaluation':
      resumeStore.updateSelfEvaluation(data)
      break
  }
}

// å¤åˆ¶æ¡ç›®
const copyEntry = (moduleId, entryIndex) => {
  const data = resumeStore[moduleId]
  if (Array.isArray(data) && data[entryIndex]) {
    const entry = { ...data[entryIndex] }
    switch (moduleId) {
      case 'work-experience':
        resumeStore.addWorkExperience(entry)
        break
      case 'education':
        resumeStore.addEducation(entry)
        break
      case 'project':
        resumeStore.addProject(entry)
        break
    }
  }
}

// åˆ é™¤æ¡ç›®
const deleteEntry = (moduleId, entryIndex) => {
  switch (moduleId) {
    case 'work-experience':
      resumeStore.deleteWorkExperience(entryIndex)
      break
    case 'education':
      resumeStore.deleteEducation(entryIndex)
      break
    case 'project':
      resumeStore.deleteProject(entryIndex)
      break
  }
}

// æ‹–æ‹½å¤„ç†
const handleDragStart = (event, index) => {
  draggedIndex.value = index
  event.dataTransfer.effectAllowed = 'move'
  event.dataTransfer.setData('text/plain', index)
}

const handleDragOver = (event, index) => {
  event.preventDefault()
  dragOverIndex.value = index
  event.dataTransfer.dropEffect = 'move'
}

const handleDragLeave = () => {
  dragOverIndex.value = null
}

const handleDrop = (event, index) => {
  event.preventDefault()
  dragOverIndex.value = null
  
  if (draggedIndex.value !== null && draggedIndex.value !== index) {
    // æ›´æ–°æ¨¡å—é¡ºåº
    const newOrder = [...resumeStore.moduleOrder]
    const [movedModule] = newOrder.splice(draggedIndex.value, 1)
    newOrder.splice(index, 0, movedModule)
    resumeStore.updateModuleOrder(newOrder)
  }
}

const handleDragEnd = () => {
  dragOverIndex.value = null
  draggedIndex.value = null
}
</script>